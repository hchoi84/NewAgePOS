@page "{saleid:min(1)}"
@model NewAgePOS.Pages.Sale.CheckoutModel
@{
  ViewData["Title"] = "Checkout";
  CultureInfo dollar = new CultureInfo("en-US");
}

@if (TempData["Message"] != null)
{
  <div class="text-danger">@TempData["Message"]</div>
}

<h3 class="mt-5">PRODUCTS</h3>
@foreach (var saleLine in Model.SaleLines)
{
  float priceAfterDisc = saleLine.Price * (1 - saleLine.DiscPct / 100f);
  string name;

  @if (saleLine != Model.SaleLines.First())
  {
    <div class="mt-3"></div>
  }

  @if (saleLine.ProductId.HasValue)
  {
    name = Model.Products.FirstOrDefault(p => p.Id == saleLine.ProductId.Value).AllName;
  }
  else
  {
    name = Model.GiftCards.FirstOrDefault(g => g.Id == saleLine.GiftCardId.Value).Code;
  }

  <div class="row">
    <div class="col">
      <div class="border border-dark rounded bg-dark p-1">@name</div>
    </div>
  </div>
  <div class="row">
    <div class="col pr-0">
      <div class="border border-dark rounded bg-dark p-1">
        @if (saleLine.Price == priceAfterDisc)
        {
          @saleLine.Price.ToString("C2", dollar)
        }
        else
        {
          <span class="small"><s>@saleLine.Price.ToString("C2", dollar)</s></span>
          <span>@priceAfterDisc.ToString("C2", dollar)</span>
        }
      </div>
    </div>
    <div class="col pl-0">
      <div class="border border-dark rounded bg-dark p-1">
        @saleLine.Qty
      </div>
    </div>
  </div>
}

<h3 class="mt-5">CUSTOMER INFO</h3>
@if (Model.Customer.EmailAddress == "guest@email.com")
{
  <h4>Guest Account</h4>
}
else
{
  <div class="form-row">
    <div class="col pr-0">
      <input readonly value="@Model.Customer.FirstName" class="form-control border-dark" />
    </div>
    <div class="col pl-0">
      <input readonly value="@Model.Customer.LastName" class="form-control border-dark" />
    </div>
  </div>
  <div class="form-row">
    <div class="col pr-0">
      <input readonly value="@Model.Customer.EmailAddress" class="form-control border-dark" />
    </div>
    <div class="col pl-0">
      <input readonly value="@Model.Customer.PhoneNumber" class="form-control border-dark" />
    </div>
  </div>
}

@if (Model.Transactions.Any())
{
  <h4 class="mt-5">Transactions</h4>

  foreach (TransactionModel transaction in Model.Transactions)
  {
    string method;

    @if (transaction.GiftCardId.HasValue)
    {
      string code = Model.GiftCards.FirstOrDefault(g => g.Id == transaction.GiftCardId).Code;
      method = $"{ transaction.Method } ({ code })";
    }
    else
    {
      method = transaction.Method;
    }

    <div class="form-row">
      <div class="col pr-0">
        <input readonly value="@method" class="form-control" />
      </div>
      <div class="col pl-0">
        <input readonly value="@transaction.Amount.ToString("C2", dollar)" class="form-control" />
      </div>
    </div>
  }
}

<h3 class="mt-5">PAYMENT</h3>
<form method="post">
  <div class="form-row">
    <div class="col pr-0">
      <select asp-for="@Model.PaymentMethod" class="form-control" asp-items="@Model.PaymentMethods">
        <option>Choose...</option>
      </select>
    </div>
    <div class="col pl-0">
      <input asp-for="@Model.Amount" class="form-control">
    </div>
  </div>
  <div class="form-row mt-2">
    <div class="col pr-0">
      <textarea asp-for="@Model.GiftCardCodes" class="form-control" placeholder="Gift Card Codes"></textarea>
    </div>
    <div class="col pl-0">
      <textarea asp-for="@Model.Message" rows="2" class="form-control" placeholder="Internal Message"></textarea>
    </div>
  </div>
  <button type="submit" class="btn btn-success mt-1">Complete</button>
</form>

@await Component.InvokeAsync("SalePriceSummary", new { saleLines = Model.SaleLines, taxPct = Model.TaxPct, transactions = Model.Transactions })
